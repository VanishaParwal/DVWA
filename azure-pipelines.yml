trigger:
- azure-pipelines.yml

# FIX 1: Corrected Pool syntax
pool:
  name: Default
  demands:
    - Agent.Name -equals HPV

# FIX 2: Variables moved to the top level
variables:
  - name: imageRepository
    value: azuredevopstest
  - name: imageTag
    value: v1

steps:
- checkout: self

# Build Step
- task: Docker@2
  displayName: "Build Docker Image"
  inputs:
    command: build
    Dockerfile: "**/Dockerfile"
    repository: "$(imageRepository)"
    tags: '$(imageTag)'

# FIX 3: Scan Step now uses the SAME variables as the build
- task: AccuKnox-Container-Scan@2
  displayName: "AccuKnox Container Scan"
  inputs:
    imageName: '$(imageRepository)' # Changed from 'dvwa' to match your build
    tag: '$(imageTag)'              # Changed from 'latest' to match 'v1'
    accuknoxEndpoint: '$(accuknox_endpoint)'
    accuknoxToken: '$(azure_token)'
    accuknoxLabel: '$(accuknox_label)'
    inputSoftFail: true